# ansible/playbooks/roles/bind_dns/tasks/main.yml
---
- name: Ensure Docker is installed
  ansible.builtin.include_role:
    name: docker

- name: Detect ZeroTier interface
  ansible.builtin.set_fact:
    bind_dns_zerotier_interface: "{{ ansible_interfaces | select('match', '^zt') | list | first | default('') }}"

- name: Fail if ZeroTier interface not found
  ansible.builtin.fail:
    msg: "No ZeroTier interface found"
  when: bind_dns_zerotier_interface | length == 0

- name: Gather ZeroTier IP address
  ansible.builtin.set_fact:
    bind_dns_zerotier_ip: "{{ hostvars[inventory_hostname]['ansible_' ~ bind_dns_zerotier_interface]['ipv4']['address'] }}"

- name: Ensure bind_dns directory exists
  ansible.builtin.file:
    path: "{{ bind_dns_dir }}"
    state: directory
    mode: '0755'

- name: Ensure zones directory exists
  ansible.builtin.file:
    path: "{{ bind_dns_dir }}/zones"
    state: directory
    mode: '0755'

- name: Query NetBox for IP addresses
  ansible.builtin.uri:
    url: "{{ netbox_url }}/api/ipam/ip-addresses/?limit=0"
    method: GET
    headers:
      Authorization: "Token {{ netbox_token }}"
      Accept: application/json
    return_content: true
    validate_certs: false
  register: bind_dns_netbox_hosts

- name: Deploy forward zone file
  ansible.builtin.template:
    src: zone.j2
    dest: "{{ bind_dns_dir }}/zones/db.{{ bind_dns_domain }}"
    mode: '0644'
  vars:
    dns_records: "{{ bind_dns_netbox_hosts.json.results }}"
    zone_serial: "{{ '%Y%m%d%H' | strftime }}"
  notify: restart bind

- name: Deploy named.conf
  ansible.builtin.template:
    src: named.conf.j2
    dest: "{{ bind_dns_dir }}/named.conf"
    mode: '0644'
  notify: restart bind

- name: Deploy docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ bind_dns_dir }}/docker-compose.yml"
    mode: '0644'

- name: Launch bind container
  community.docker.docker_compose_v2:
    project_src: "{{ bind_dns_dir }}"
    state: present
  register: bind_dns_compose

- name: Display compose status
  ansible.builtin.debug:
    var: bind_dns_compose
